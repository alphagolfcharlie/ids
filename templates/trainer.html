{% extends "base.html" %}

{% block content %}
<div class="container">
  <h1>Flight Plan Trainer</h1>

  <div class="flight-card">
    <h2>Presented Flight Plan</h2>
    <p><strong>AID:</strong> {{ plan.aid }}</p>
    <p><strong>DEP → DEST:</strong> {{ plan.dep }} → {{ plan.dest }}</p>
    <p><strong>Altitude:</strong> {{ plan.alt }}</p>
    <p><strong>Route:</strong> {{ plan.rte }}</p>
  </div>

  <form id="correctionForm" class="form-section">
    <input type="hidden" name="aid" value="{{ plan.aid }}">
    <label>Corrected Route</label>
    <input type="text" name="rte" placeholder="Enter corrected route">
    <label>Corrected Altitude</label>
    <input type="text" name="alt" placeholder="Enter corrected altitude">
    <button type="submit" class="amend-btn">Amend</button>
  </form>

  <div id="feedback" class="feedback"></div>

  <div style="text-align:center; margin-top:20px;">
    <button id="viewStudentRoute" class="amend-btn" style="width:250px;">View Your Route on SkyVector</button>
    <a id="studentSkyvectorLink" href="#" target="_blank" style="display:none;"></a>
  </div>

  <div id="revealSection" style="display:none; text-align:center; margin-top:20px;">
    <button id="revealCorrectBtn" class="amend-btn" style="background-color:#ffa726;">Reveal Correct Route</button>
    <div id="correctRouteBox" style="display:none; margin-top:15px; color:#ffcc00;">
      <p><strong>Correct Route:</strong> <span id="correctRouteText"></span></p>
      <a id="correctRouteLink" href="#" target="_blank" class="amend-btn" style="background-color:#00e676; color:black;">View Correct Route on SkyVector</a>
    </div>
  </div>

  <form action="/trainer" method="get" style="text-align:center; margin-top:20px;">
    <button type="submit" class="amend-btn" style="width:200px;">Next Plan</button>
  </form>
</div>

<script>
  const dep = "{{ plan.dep }}";
  const dest = "{{ plan.dest }}";
  let lastStudentUrl = "#";

  document.getElementById("correctionForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(this).entries());

    const res = await fetch('/trainer/check', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await res.json();
    let feedback = "";
    feedback += result.rte_correct ? "✅ Route correct. " : "❌ Route incorrect. ";
    feedback += result.alt_correct ? "✅ Altitude correct." : "❌ Altitude incorrect.";
    document.getElementById("feedback").innerHTML = feedback;

    // Update SkyVector link
    const rte = data.rte.trim().replace(/\s+/g, '%20');
    lastStudentUrl = `https://skyvector.com/?fpl=${dep}%20${rte}%20${dest}`;

    // Show reveal button if allowed
    if (result.show_reveal) {
      document.getElementById("revealSection").style.display = "block";
      if (result.correct_route) {
        document.getElementById("revealCorrectBtn").onclick = () => {
          const route = Array.isArray(result.correct_route) ? result.correct_route[0] : result.correct_route;
          document.getElementById("correctRouteText").textContent = route;
          document.getElementById("correctRouteLink").href = `https://skyvector.com/?fpl=${dep}%20${route.replace(/\s+/g, '%20')}%20${dest}`;
          document.getElementById("correctRouteBox").style.display = "block";
        };
      }
    }
  });

  document.getElementById("viewStudentRoute").onclick = () => {
    if (lastStudentUrl !== "#") window.open(lastStudentUrl, '_blank');
  };
</script>
{% endblock %}
